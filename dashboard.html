<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FVSS Bonus - Dashboard</title>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f9; }
        h1 { color: #3a3a3a; font-size: 32px; margin-top: 20px; }
        .points { font-size: 36px; font-weight: bold; color: #2d9cdb; margin: 20px; }
        button { background: #2d9cdb; color: white; padding: 12px 20px; border: none; cursor: pointer; border-radius: 5px; margin: 10px; }
        #scanner-container { margin: 20px auto; width: 300px; height: 300px; display: none; }
        .user-info { font-size: 18px; color: #333; margin-bottom: 20px; }
    </style>
</head>
<body>

    <h1>Dein FVSS Bonus</h1>
    <p class="user-info" id="user-info"></p>
    <p class="points" id="points">0,0 Punkte</p>

    <button onclick="startScanner()">QR-Code scannen</button>
    <button onclick="addPoints()">Punkte hinzufügen</button>

    <div id="scanner-container"></div>

    <div>
        <input type="number" id="betrag" placeholder="Betrag eingeben (€)" step="0.01">
    </div>

    <script>
        let user = "";
        let points = 0.0;

        // Benutzer aus der URL holen
        function getUserFromURL() {
            const params = new URLSearchParams(window.location.search);
            user = params.get("user") || "Unbekannter Nutzer";
            document.getElementById("user-info").innerText = `Angemeldet als: ${user}`;
            
            // Lade gespeicherte Punkte für diesen Benutzer
            const storedPoints = localStorage.getItem(`points_${user}`);
            if (storedPoints) {
                points = parseFloat(storedPoints);
                document.getElementById("points").innerText = points.toFixed(1) + " Punkte";
            }
        }

        function startScanner() {
            document.getElementById("scanner-container").style.display = "block";
            const html5QrCode = new Html5Qrcode("scanner-container");

            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    html5QrCode.stop();
                    document.getElementById("scanner-container").style.display = "none";
                    handleQRCode(decodedText);
                },
                (errorMessage) => {}
            );
        }

        function handleQRCode(qrCode) {
            if (qrCode === "85274319") { // Punkte sammeln
                let betrag = parseFloat(prompt("Wie viel hast du bezahlt? (in €)"));
                if (isNaN(betrag) || betrag <= 0) {
                    alert("Bitte einen gültigen Betrag eingeben!");
                    return;
                }
                let newPoints = betrag * 0.5;
                points += Math.round(newPoints * 2) / 2;
            } else if (qrCode === "43896712") { // Punkte ausgeben
                let abziehen = parseFloat(prompt("Wie viele Punkte möchtest du abziehen?"));
                if (isNaN(abziehen) || abziehen <= 0 || abziehen > points) {
                    alert("Ungültige Eingabe! Stelle sicher, dass du genügend Punkte hast.");
                    return;
                }
                points -= abziehen;
            } else {
                alert("Ungültiger QR-Code!");
                return;
            }

            document.getElementById("points").innerText = points.toFixed(1) + " Punkte";
            localStorage.setItem(`points_${user}`, points);
        }

        function addPoints() {
            let betrag = parseFloat(document.getElementById("betrag").value);
            if (isNaN(betrag) || betrag <= 0) {
                alert("Bitte einen gültigen Betrag eingeben!");
                return;
            }

            let newPoints = betrag * 0.5;
            points += Math.round(newPoints * 2) / 2;
            document.getElementById("points").innerText = points.toFixed(1) + " Punkte";
            localStorage.setItem(`points_${user}`, points);
        }

        getUserFromURL();
    </script>

</body>
</html>
