<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FVSS Bonus - Dashboard</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; background: #ffcc00; }
        .splash { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: #ffcc00; color: white; font-size: 24px; }
        .dashboard { display: none; padding: 20px; text-align: center; }
        h1 { color: #3a3a3a; font-size: 28px; margin-top: 20px; }
        .points-container { background: white; padding: 15px; border-radius: 10px; display: inline-block; margin: 20px; }
        .points { font-size: 36px; font-weight: bold; color: #d32f2f; }
        button { background: #d32f2f; color: white; padding: 12px 20px; border: none; cursor: pointer; border-radius: 5px; margin: 10px; font-size: 18px; }
        #reader { width: 300px; height: 300px; margin: 20px auto; display: none; }
    </style>
</head>
<body>

    <div class="splash">
        <h1 id="welcome"></h1>
        <p>Lädt...</p>
    </div>

    <div class="dashboard">
        <h1>FVSS Bonus</h1>
        <div class="points-container">
            <p class="points" id="points">0,0 Punkte</p>
        </div>

        <button onclick="startScanner()">QR-Code scannen</button>
        <div id="reader"></div>
    </div>

    <script>
        let user = "";
        let points = 0.0;
        let scanner = null;

        function getUserFromURL() {
            const params = new URLSearchParams(window.location.search);
            user = params.get("user") || "Gast";
            document.getElementById("welcome").innerText = `Willkommen, ${user}!`;

            const storedPoints = localStorage.getItem(`points_${user}`);
            if (storedPoints) {
                points = parseFloat(storedPoints);
                document.getElementById("points").innerText = points.toFixed(1) + " Punkte";
            }

            setTimeout(() => {
                document.querySelector(".splash").style.display = "none";
                document.querySelector(".dashboard").style.display = "block";
            }, 2000);
        }

        function startScanner() {
            document.getElementById("reader").style.display = "block";

            if (!scanner) {
                scanner = new Html5Qrcode("reader");

                scanner.start(
                    { facingMode: "environment" },  // Rückkamera verwenden
                    { fps: 10, qrbox: 250 },
                    (decodedText) => {
                        stopScanner();
                        handleQRCode(decodedText);
                    },
                    (errorMessage) => { }
                ).catch(err => {
                    alert("Kamera kann nicht gestartet werden: " + err);
                });
            }
        }

        function stopScanner() {
            if (scanner) {
                scanner.stop().then(() => {
                    document.getElementById("reader").style.display = "none";
                    scanner = null;
                }).catch(err => console.log("Scanner konnte nicht gestoppt werden: ", err));
            }
        }

        function handleQRCode(qrCode) {
            if (qrCode === "85274319") {
                let betrag = parseFloat(prompt("Wie viel hast du bezahlt? (in €)"));
                if (isNaN(betrag) || betrag <= 0) {
                    alert("Ungültiger Betrag!");
                    return;
                }
                let newPoints = betrag * 0.5;
                points += Math.round(newPoints * 2) / 2;
            } else if (qrCode === "43896712") {
                let abziehen = parseFloat(prompt("Wie viele Punkte möchtest du abziehen?"));
                if (isNaN(abziehen) || abziehen <= 0 || abziehen > points) {
                    alert("Ungültige Eingabe!");
                    return;
                }
                points -= abziehen;
            } else {
                alert("Ungültiger QR-Code!");
                return;
            }

            document.getElementById("points").innerText = points.toFixed(1) + " Punkte";
            localStorage.setItem(`points_${user}`, points);
        }

        getUserFromURL();
    </script>

</body>
</html>
